name: Sovereign CI — Python

on:
  push:
    branches: [ main, master, feature/*, release/* ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  actions: read

jobs:
  lint-and-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install linting tools
        run: pip install ruff mypy bandit pyyaml types-PyYAML
      - name: Run linter (Ruff)
        run: ruff check . --config pyproject.toml || ruff check .
      - name: Run type checker (Mypy)
        run: mypy . --ignore-missing-imports --no-error-summary || true
      - name: Run security scan (Bandit)
        run: bandit -r . -ll --exclude ./tests,./archive || true

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint-and-validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run unit tests
        run: |
          if [ -d tests ]; then
            pytest tests/ -v --tb=short --junitxml=test-results.xml || true
          else
            echo "No tests/ directory — skipping"
          fi

  evidence-chain:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Verify SHA-256 hashes
        run: |
          python3 -c "
          import json, hashlib, glob, sys
          errors = 0
          for f in glob.glob('**/*.json', recursive=True):
              try:
                  data = json.load(open(f))
                  if isinstance(data, dict) and 'sha256' in data:
                      content = json.dumps({k:v for k,v in data.items() if k != 'sha256'}, sort_keys=True)
                      expected = hashlib.sha256(content.encode()).hexdigest()
                      if data['sha256'] != expected:
                          print(f'HASH MISMATCH: {f}'); errors += 1
              except: pass
          sys.exit(1 if errors > 0 else 0)
          "

  trust-gate:
    runs-on: ubuntu-latest
    needs: [lint-and-validate, unit-tests, evidence-chain]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Trust Gate — T0 Advisory
        run: |
          echo "TRUST GATE: T0 — ADVISORY"
          echo "All stages passed. Manual deployment approval required."
